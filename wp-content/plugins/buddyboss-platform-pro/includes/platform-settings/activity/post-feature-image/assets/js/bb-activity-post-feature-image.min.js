!function(l){"use strict";var c={_eventsBound:!1,bbActivityFeatureImage:_.isUndefined(BP_Nouveau.activity.params.post_feature_image)?{}:BP_Nouveau.activity.params.post_feature_image,cropperInstance:null,currentFile:null,fileID:null,canEditFeatureImage:!0,init:function(){this.initFeatureImageView(),this.bindEvents(),this.initDropzone()},initDropzone:function(){void 0!==window.Dropzone&&(window.Dropzone.autoDiscover=!1)},bindEvents:function(){var a,i,r,n;this._eventsBound||(a=l("body"),i=l("#whats-new-form"),r="#aw-whats-new-reset",n=".activity-header .close",i.length||(i=l("#bb-rl-whats-new-form"),r="#bb-rl-aw-whats-new-reset",n=".bb-rl-activity-header .close"),l(document).ready(function(){a.on("bb_activity_event",function(e,t){switch(t.type){case"bb_activity_attachments_destroy":c.handleAttachmentsDestroyEvent(e,t);break;case"bb_activity_form_data":c.handleFormDataEvent(e,t,i);break;case"bb_activity_reset_draft":c.handleResetDraftEvent(e,t,i);break;case"bb_activity_post_success":c.handlePostSuccessEvent(e,t);break;case"bb_activity_edit_loaded_at_end":c.handlePostEditEvent(e,t);break;case"bb_activity_draft_loaded":c.handleDraftLoadedEvent(e,t);break;case"bb_activity_draft_data_keys":c.handleDraftDataKeysEvent(e,t);break;case"bb_activity_draft_collect_activity":c.handleDraftCollectActivityEvent(e,t);break;case"bb_activity_privacy_changed":c.handlePrivacyChangedEvent(e,t);break;case"bb_activity_form_prep":c.handleFormPrepEvent(e,t)}}),Backbone.on("privacy:headerupdate",function(){i.find(".bb-activity-post-feature-image-button").addClass("bp-hide")}),Backbone.on("privacySelector",function(){"user"!==c.getCurrentModel().get("object")||_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)?i.find(".bb-activity-post-feature-image-button").addClass("bp-hide"):i.find(".bb-activity-post-feature-image-button").removeClass("bp-hide")}),l(document).on("click",r+", "+n,function(e){void 0!==c&&c.handleFormClose&&c.handleFormClose(e),void 0!==c&&c.closeCropper()});var e=null,t=!1;c.isReadyToInitialize()?c.init():(e=c.setupMutationObserver(function(){t=c.initializeFeatureImage(e,t)}),setTimeout(function(){e&&e.disconnect(),t||c.init()},5e3))}),l(document).off("click","#bb-activity-post-feature-image-control"),l(document).on("click","#bb-activity-post-feature-image-control",this.handleButtonClick),"undefined"!=typeof Cropper&&(l(document).on("click",".bb-feature-image-crop-btn",this.handleCropButtonClick),l(document).on("click",".bb-feature-image-crop-save",this.handleCropSave),l(document).on("click",".bb-feature-image-crop-cancel",this.handleCropCancel)),this._eventsBound=!0)},handleAttachmentsDestroyEvent:function(e,t){t=t&&t.draft_activity||bp.draft_activity||{};void 0!==t.is_discard_draft_activity&&!1!==t.is_discard_draft_activity||(bp.draft_activity.allow_delete_post_feature_image=!1),c.destroyFeatureImageDropzone()},handleFormDataEvent:function(e,t,a){_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)||a.find(".bb-activity-post-feature-image-button").removeClass("bp-hide");a=_.isUndefined(t.data.bb_activity_post_feature_image)||_.isUndefined(t.data.bb_activity_post_feature_image.id)?"":t.data.bb_activity_post_feature_image.id;_.isUndefined(t.data.can_upload_post_feature_image)||delete t.data.can_upload_post_feature_image,_.isUndefined(t.data.bb_activity_post_feature_image)||delete t.data.bb_activity_post_feature_image,t.model&&t.model.unset&&!_.isUndefined(t.model.attributes.can_upload_post_feature_image)&&t.model.unset("can_upload_post_feature_image"),t.model&&t.model.attributes&&!_.isUndefined(t.model.attributes.can_upload_post_feature_image)&&delete t.model.attributes.can_upload_post_feature_image,void 0===c||_.isUndefined(t.data)||_.isUndefined(a)||""===a||(t.data=_.extend(t.data,{bb_activity_post_feature_image_id:a,bb_activity_post_feature_image_nonce:c.bbActivityFeatureImage.nonce.save}))},handleResetDraftEvent:function(e,t,a){_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)||a.find(".bb-activity-post-feature-image-button").removeClass("bp-hide")},handlePostSuccessEvent:function(e,t){void 0!==c&&c.handleActivityPostSuccess&&c.handleActivityPostSuccess(t)},handlePostEditEvent:function(e,t){void 0!==c&&c.handleActivityEditLoaded&&(bp.draft_activity.allow_delete_post_feature_image=!0,c.handleActivityEditLoaded(t))},handleDraftLoadedEvent:function(e,t){void 0!==c&&c.handleActivityDraftLoaded&&(bp.draft_activity.allow_delete_post_feature_image=!0,c.handleActivityDraftLoaded(t))},handleDraftDataKeysEvent:function(e,t){t.draft_data_keys.push("feature_image_allowed"),t.draft_data_keys.push("bb_activity_post_feature_image")},handleDraftCollectActivityEvent:function(e,t){void 0!==c&&c.handleActivityDraftCollectActivity&&c.handleActivityDraftCollectActivity(t)},handlePrivacyChangedEvent:function(e,t){void 0!==c&&c.handleActivityPrivacyChanged&&c.handleActivityPrivacyChanged(t)},handleFormPrepEvent:function(e,t){void 0!==c&&c.handleActivityFormPrep&&c.handleActivityFormPrep(t)},handleButtonClick:function(e){e.preventDefault(),e.stopPropagation();var t,e=l("#bb-activity-post-feature-image"),a=l("#whats-new-form");a.length||(a=l("#bb-rl-whats-new-form")),e.length&&(e.is(":visible")?(e.hide(),l(this).removeClass("active")):(e.show(),l(this).addClass("active"),(t=(t=a.find("#user-status-huddle")).length?t:a.find("#bb-rl-user-status-huddle")).length&&e.insertAfter(t),void 0===window.Dropzone||e.data("dropzone-initialized")||c.initializeDropzone(e)))},handleCropButtonClick:function(e){var t;e.preventDefault(),e.stopPropagation(),"undefined"!=typeof Cropper&&(e=l(e.target).closest(".dz-preview").find(".dz-image img"),(t=l("#whats-new-form")).length||(t=l("#bb-rl-whats-new-form")),e.length)&&(l(t).addClass(c.getFocusClass()),c.openCropper(e[0]))},handleCropSave:function(e){e.preventDefault(),e.stopPropagation(),c.saveCrop()},handleCropCancel:function(e){e.preventDefault(),e.stopPropagation(),c.closeCropper()},openCropper:function(e){var t=l("#bb-activity-post-feature-image"),a=t.find(".bb-feature-image-cropper-section"),t=t.find("#activity-post-feature-image-uploader");a.addClass("bb-cropper-entering"),a.show(),t.hide(),this.initCropper(e),setTimeout(function(){a.removeClass("bb-cropper-entering")},50)},initCropper:function(e){if("undefined"!=typeof Cropper){var t=this,a=l("#bb-feature-image-to-crop");if(a.attr("src",""),a.attr("src",e.src),this.cropperInstance){try{this.cropperInstance.destroy()}catch(e){console.warn(c.bbActivityFeatureImage.strings.error_dc,e)}this.cropperInstance=null}this.cropperInstance=new Cropper(a[0],{aspectRatio:3.7,viewMode:1,dragMode:"move",autoCropArea:1,restore:!1,guides:!1,center:!1,highlight:!1,cropBoxMovable:!1,cropBoxResizable:!1,toggleDragModeOnDblclick:!1,ready:function(){},crop:function(e){t.cropData={x:Math.round(e.detail.x),y:Math.round(e.detail.y),width:Math.round(e.detail.width),height:Math.round(e.detail.height)}}})}},saveCrop:function(){var r,n,o;this.cropperInstance&&this.cropData?(r=this,(n=l("#whats-new-form")).length||(n=l("#bb-rl-whats-new-form")),(o=this.cropperInstance.getCroppedCanvas({width:1200,height:436,fillColor:"#fff",imageSmoothingEnabled:!0,imageSmoothingQuality:"high"}))&&o.toBlob(function(e){var t=new FormData,a=0,i=".bb-rl-groups-single-wrapper",i=(l(i).length||(i="#item-header"),l(i).length&&"groups"===l(i).data("bp-item-component")?a=l(i).data("bp-item-id"):_.isUndefined(c.getCurrentModel().get("object"))||"group"!==c.getCurrentModel().get("object")||_.isUndefined(c.getCurrentModel().get("item_id"))||(a=c.getCurrentModel().get("item_id")),t.append("action","activity_post_feature_image_crop_replace"),t.append("_wpnonce",c.bbActivityFeatureImage.nonce.crop_replace),t.append("postid",c.fileID),t.append("group_id",a),t.append("file",e,"cropped-image.jpg"),l("#activity-post-feature-image-uploader"));i.length&&i[0].dropzone&&0<(a=i[0].dropzone).files.length&&((e=a.files[0]).dataURL=o.toDataURL("image/jpeg",.9),e.cropped=!0,e.cropData=r.cropData,i=a.element.querySelector(".dz-preview"))&&((e=i.querySelector(".dz-image img"))&&(e.src=o.toDataURL("image/jpeg",.9)),a=i.querySelector(".bb-feature-image-crop-overlay"))&&(a.style.display="none"),l.ajax({url:BP_Nouveau.ajaxurl,type:"POST",data:t,processData:!1,contentType:!1,success:function(e){var t;e.data&&e.data.id&&((t=l("#activity-post-feature-image-uploader")).length&&t[0].dropzone&&0<(t=t[0].dropzone).files.length&&((t=t.files[0]).serverCropResponse=e.data,t.cropped=!0,(e=l(t.previewElement)).length&&e.find(".bb-feature-image-crop-overlay").remove(),t=c.getCurrentModel().get("bb_activity_post_feature_image"))&&(t.cropped=!0,c.getCurrentModel().set("bb_activity_post_feature_image",t)),l(n).removeClass(c.getFocusClass()))},error:function(e,t,a){console.error(c.bbActivityFeatureImage.strings.crop_operation_failed,a),console.error(c.bbActivityFeatureImage.strings.failed_to_save_cropped_image),l(n).removeClass(c.getFocusClass())}}),r.closeCropper()},"image/jpeg",.9)):this.closeCropper()},closeCropper:function(){var t=this,e=l("#bb-activity-post-feature-image"),a=e.find(".bb-feature-image-cropper-section"),i=e.find("#activity-post-feature-image-uploader");a.addClass("bb-cropper-leaving"),setTimeout(function(){if(t.cropperInstance){try{t.cropperInstance.destroy()}catch(e){console.warn(c.bbActivityFeatureImage.strings.error_dc,e)}t.cropperInstance=null}a.hide().removeClass("bb-cropper-entering bb-cropper-leaving"),i.show();var e=l("#whats-new-form");e.length||(e=l("#bb-rl-whats-new-form")),l(e).removeClass(c.getFocusClass()),t.cropData=null},200)},handleFormClose:function(){this.closeCropper()},cleanup:function(){if(this.cropperInstance){try{this.cropperInstance.destroy()}catch(e){console.warn(c.bbActivityFeatureImage.strings.error_dc_during_cleanup,e)}this.cropperInstance=null}var e=l("#activity-post-feature-image-uploader");if(e.length&&e[0].dropzone)try{e[0].dropzone.destroy(),e[0].dropzone=null}catch(e){console.warn(c.bbActivityFeatureImage.strings.error_dd_during_cleanup,e)}this.currentFile=null,this.fileID=null,this.cropData=null},initializeDropzone:function(i){var a,r,e,t;i.find("#activity-post-feature-image-uploader").length&&!i.data("dropzone-initialized")&&(a=null,l(r="#whats-new-form").length||(r="#bb-rl-whats-new-form"),e={url:BP_Nouveau.ajaxurl,timeout:108e5,dictFileTooBig:_.isUndefined(bp_media_dropzone)?"":bp_media_dropzone.dictFileTooBig,acceptedFiles:"image/*",autoProcessQueue:!0,addRemoveLinks:!0,uploadMultiple:!1,maxFiles:c.bbActivityFeatureImage.config.max_file,maxFilesize:c.bbActivityFeatureImage.config.max_upload_size,thumbnailWidth:null,thumbnailHeight:null,previewTemplate:document.getElementsByClassName("activity-post-feature-image-default-template")[0]?document.getElementsByClassName("activity-post-feature-image-default-template")[0].innerHTML:"",maxThumbnailFilesize:c.bbActivityFeatureImage.config.max_file||2,preventDuplicates:!0},(t=new window.Dropzone("#activity-post-feature-image-uploader",e)).on("addedfile",function(e){l(r).addClass(c.getFocusClass()),1<t.files.length&&t.removeFile(t.files[0]),e.media_edit_data&&(a=e.media_edit_data,c.getCurrentModel().set("bb_activity_post_feature_image",a)),i.addClass("has-file")}),t.on("uploadprogress",function(e){i.closest(r).addClass("feature-image-uploading");var t=l(e.previewElement).find(".dz-progress-ring circle")[0],a=2*t.r.baseVal.value*Math.PI;t.style.strokeDasharray=a+" "+a,t.style.strokeDashoffset=a,t.style.strokeDashoffset=a-e.upload.progress.toFixed(0)/100*a}),t.on("sending",function(e,t,a){var i=0,r=".bb-rl-groups-single-wrapper";l(r).length||(r="#item-header"),l(r).length&&"groups"===l(r).data("bp-item-component")?i=l(r).data("bp-item-id"):_.isUndefined(c.getCurrentModel().get("object"))||"group"!==c.getCurrentModel().get("object")||_.isUndefined(c.getCurrentModel().get("item_id"))||(i=c.getCurrentModel().get("item_id")),a.append("action","activity_post_feature_image_upload"),a.append("group_id",i),a.append("_wpnonce",c.bbActivityFeatureImage.nonce.upload)}),t.on("success",function(o,e){var t;e.data.id?(o.id=e.data.id,e.data.uuid=o.upload.uuid,e.data.group_id=!_.isUndefined(c.bbActivityFeatureImage.group_id)&&c.bbActivityFeatureImage.group_id,e.data.saved=!1,(a=e.data).can_edit_feature_image=!0,a.cropped=!1,c.getCurrentModel().set("bb_activity_post_feature_image",a),e.data.url&&(t=l(o.previewElement).find(".dz-image > img")).length&&(o.cropped?(o.serverUrl=e.data.url,o.serverThumbnail=e.data.url):(t.off("load error").on("load",function(){l(o.previewElement).removeClass("dz-error"),l(o.previewElement).find(".dz-error-message").hide(),l(o.previewElement).removeClass("bb-processing")}).on("error",function(){var e,t,a,i,r,n=c.bbActivityFeatureImage.invalid_media_type;for(o.previewElement.classList.add("dz-error"),r=[],t=0,a=(i=o.previewElement.querySelectorAll("[data-dz-errormessage]")).length;t<a;t++)e=i[t],r.push(e.textContent=n);c.clearFeatureImage()}),t.attr("src",e.data.url),t.attr("data-dz-thumbnail",e.data.url),l(o.previewElement).addClass("bb-processing"))),c.fileID=e.data.id):(Backbone.trigger("onError","<div>"+c.bbActivityFeatureImage.invalid_media_type+". "+e.data.feedback+"</div>"),this.removeFile(o)),bp.draft_content_changed=!0}),t.on("error",function(e,t){var a;e.accepted?(a=c.getErrorMessage(e.xhr,t),_.isUndefined(t)||_.isUndefined(t.data)||_.isUndefined(t.data.feedback)?"error"===e.status&&e.xhr&&0===e.xhr.status?l(e.previewElement).find(".dz-error-message span").text(c.bbActivityFeatureImage.connection_lost_error):l(e.previewElement).find(".dz-error-message span").text(a):l(e.previewElement).find(".dz-error-message span").text(t.data.feedback)):(a=c.bbActivityFeatureImage.invalid_media_type,t&&"object"==typeof t?t.data&&t.data.feedback?a+=". "+t.data.feedback:t.message?a+=". "+t.message:a+=". "+c.bbActivityFeatureImage.strings.upload_failed:t&&"string"==typeof t&&(a+=". "+t),Backbone.trigger("onError","<div>"+a+"</div>"),this.removeFile(e),i.closest(r).removeClass("feature-image-uploading"))}),t.on("removedfile",function(e){var t=c.getCurrentModel().get("bb_activity_post_feature_image");!0===bp.draft_activity.allow_delete_post_feature_image&&(e.id&&t&&(!_.isUndefined(t.saved)&&!t.saved||!_.isUndefined(t.can_edit_feature_image)&&!t.can_edit_feature_image)&&c.removeAttachment(e.id),c.getCurrentModel().set("bb_activity_post_feature_image",null),bp.draft_activity.data&&"object"==typeof bp.draft_activity.data&&(bp.draft_activity.data.bb_activity_post_feature_image=null),c.clearFeatureImage(),i.removeClass("has-file"),i.closest(r).removeClass("feature-image-uploading"),0===this.files.length&&i.removeClass("dz-started"),l("#message-feedabck").hasClass("noMediaError")&&c.getCurrentModel().unset("errors"),bp.draft_content_changed=!0)}),t.on("complete",function(e){var t=e.cropped||e.media_edit_data&&e.media_edit_data.cropped,e=(_.isUndefined(c.canEditFeatureImage)||!0!==Boolean(c.canEditFeatureImage)||c.addPositionControls(e.previewElement,t),l("#whats-new"));(e=e.length?e:l("#bb-rl-whats-new")).trigger("input"),0===this.getUploadingFiles().length&&0===this.getQueuedFiles().length&&i.closest(r).removeClass("feature-image-uploading")}),i.find("#activity-post-feature-image-uploader").addClass("open").removeClass("closed"),l("#whats-new-attachments").removeClass("empty").closest(r).addClass("focus-in--attm"),i.data("dropzone-initialized",!0))},isReadyLaunch:function(){return 0<l("#bb-rl-whats-new-form").length||0<l("#bb-rl-user-status-huddle").length},getFocusClass:function(){return this.isReadyLaunch()?"bb-rl-focus-in--empty":"focus-in--empty"},addPositionControls:function(e,t){e=l(e);e.attr("data-position","center"),t||"undefined"!=typeof Cropper&&(t=this.isReadyLaunch()?"bb-icons-rl-crop":"bb-icon-l bb-icon-crop",t=l('<div class="bb-feature-image-crop-overlay"><button type="button" class="bb-feature-image-crop-btn" title="'+c.bbActivityFeatureImage.strings.reposition_crop_image+'"><i class="'+t+'"></i><span>'+c.bbActivityFeatureImage.strings.reposition_crop+"</span></button></div>"),e.append(t))},removeAttachment:function(e){var e={action:"activity_post_feature_image_delete",_wpnonce:c.bbActivityFeatureImage.nonce.delete,id:e},t=l("#bp-activity-id").val();t&&(e.activity_id=t),l.ajax({type:"POST",url:BP_Nouveau.ajaxurl,data:e}),_.isUndefined(c.canEditFeatureImage)||!1!==Boolean(c.canEditFeatureImage)||(c.destroyFeatureImageDropzone(),l("#bb-activity-post-feature-image").hide())},getCurrentModel:function(){return(bp.Nouveau.Activity.postForm.postForm?bp.Nouveau.Activity.postForm:bp.Nouveau.Activity).postForm.model},clearFeatureImage:function(){c.getCurrentModel().unset("bb_activity_post_feature_image")},destroyFeatureImageDropzone:function(){var e=l("#activity-post-feature-image-uploader");if(e.length&&e[0].dropzone)try{e[0].dropzone.destroy(),e[0].dropzone=null}catch(e){console.warn(c.bbActivityFeatureImage.strings.error_destroying_dropzone,e)}l("#bb-activity-post-feature-image").removeData("dropzone-initialized"),this.closeCropper()},getErrorMessage:function(e,t){var a=c.bbActivityFeatureImage.strings.upload_failed;return e&&e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message?e.responseJSON.data.message:"string"==typeof t&&t.trim()?t:a},handleActivityPostSuccess:function(e){var t;e&&e.model&&(t=e.model.get("bb_activity_post_feature_image"),!_.isUndefined(t))&&t&&(t.saved=!0,e.model.set("bb_activity_post_feature_image",t))},handleActivityPrivacyChanged:function(e){var t,a,i,r;e&&e.model&&e.whats_new_form&&e.draft_activity&&(t=".bp-activity-privacy__input",i="#bp-item-opt-"+(r=e.model.attributes.item_id),l(a=".whats-new-form-header").length||(t=a=".bb-rl-activity-privacy__input",i="#bb-rl-item-opt-"+r),"group"===e.element.find(t+":checked").val()?(r=e.whats_new_form.find(i).data("allow-feature-image"),_.isUndefined(r)||"enabled"!==r?(c.getCurrentModel().set("feature_image_allowed","disabled"),c.getCurrentModel().set("bb_activity_post_feature_image",null),e.whats_new_form.find(".bb-activity-post-feature-image-button").addClass("bp-hide"),e.whats_new_form.find(a+" #bb-activity-post-feature-image").hide(),c.destroyFeatureImageDropzone()):(c.getCurrentModel().set("feature_image_allowed",r),e.whats_new_form.find(".bb-activity-post-feature-image-button").removeClass("bp-hide"),e.whats_new_form.find(a+" #bb-activity-post-feature-image").show())):_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)?(c.getCurrentModel().set("feature_image_allowed","disabled"),c.getCurrentModel().set("bb_activity_post_feature_image",null),e.whats_new_form.find(".bb-activity-post-feature-image-button").addClass("bp-hide"),c.destroyFeatureImageDropzone()):e.whats_new_form.find(".bb-activity-post-feature-image-button").removeClass("bp-hide"))},handleActivityFormPrep:function(e){var t;e&&e.model&&(t=e.model.get("bb_activity_post_feature_image"),"group"===e.model.get("object"))&&!_.isUndefined(t)&&t&&(t.group_id=e.model.get("item_id"),e.model.set("bb_activity_post_feature_image",t))},handleActivityEditLoaded:function(e){var t,a,i,r;e&&e.model&&e.activity_data&&(r=e.activity_data,t=l("#whats-new-form"),i="#bp-item-opt-"+r.item_id,t.length||(t=l("#bb-rl-whats-new-form"),i="#bb-rl-item-opt-"+r.item_id),a=!_.isUndefined(e.activity_data)&&!0===Boolean(e.activity_data),_.isUndefined(e)||"group"===r.privacy||_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)||t.find(".bb-activity-post-feature-image-button").removeClass("bp-hide"),"group"===r.privacy&&(i=t.find(i).data("allow-feature-image"),_.isUndefined(i)&&(_.isUndefined(r.feature_image_allowed)||"enabled"!==r.feature_image_allowed?_.isUndefined(r.feature_image_allowed)||"disabled"!==r.feature_image_allowed?_.isUndefined(c.bbActivityFeatureImage)||_.isUndefined(c.bbActivityFeatureImage.can_upload_post_feature_image)||!0!==Boolean(c.bbActivityFeatureImage.can_upload_post_feature_image)||(i="enabled"):(i="disabled",c.getCurrentModel().set("feature_image_allowed",r.feature_image_allowed)):(i=r.feature_image_allowed,c.getCurrentModel().set("feature_image_allowed",r.allow_feature_image))),_.isUndefined(i)||"enabled"!==i?t.find(".bb-activity-post-feature-image-button").addClass("bp-hide"):t.find(".bb-activity-post-feature-image-button").removeClass("bp-hide")),r=e.activity_data.bb_activity_post_feature_image,_.isUndefined(r)||(r=_.isArray(r)&&0<r.length?r[0]:r)&&(e.activity_data.bb_activity_post_feature_image=r,a&&(c.canEditFeatureImage=r.can_edit_feature_image,!0===Boolean(r.can_edit_feature_image)?t.find(".bb-activity-post-feature-image-button").removeClass("bp-hide").addClass("no-click"):t.find(".bb-activity-post-feature-image-button").addClass("bp-hide")),r.id)&&c.injectFeatureImages(e.activity_data,e.model))},handleActivityDraftLoaded:function(e){var t;e&&!e.$whatsNewForm.hasClass("bp-activity-edit")&&e.model&&e.activity_data&&(t=e.activity_data.bb_activity_post_feature_image,_.isUndefined(t)||(t=_.isArray(t)&&0<t.length?t[0]:t)&&(e.activity_data.bb_activity_post_feature_image=t,c.injectFeatureImages(e.activity_data,e.model)))},injectFeatureImages:function(e,t){var a,i,r;c._injecting||(c._injecting=!0,a=l("#bb-activity-post-feature-image"),r=l("#bb-activity-post-feature-image-control"),(i=l("#whats-new-form")).length||(i=l("#bb-rl-whats-new-form")),a.length&&(a.show(),r.length&&r.addClass("active no-click"),(r=(r=i.find("#user-status-huddle")).length?r:i.find("#bb-rl-user-status-huddle")).length&&a.insertAfter(r),void 0===window.Dropzone||a.data("dropzone-initialized")||c.initializeDropzone(a)),setTimeout(function(){c.injectFeatureImageFiles(e,t),c._injecting=!1},300))},injectFeatureImageFiles:function(e,t){var a=l("#bb-activity-post-feature-image"),i=l("#activity-post-feature-image-uploader")[0];if(!(i&&i.dropzone&&0<i.dropzone.files.length)){var r=e.bb_activity_post_feature_image;if(r){c.fileID=r.id;var n,o,d={id:r.id,name:r.name||r.alt||"Feature Image",thumb:r.thumb||r.url,medium:r.medium||r.url,url:r.url,uuid:r.uuid||r.id,group_id:r.group_id||0,saved:r.saved||!0,width:r.width,height:r.height,alt:r.alt||"",can_edit_feature_image:r.can_edit_feature_image||!1,can_delete_feature_image:r.can_delete_feature_image||!1,cropped:r.cropped||!1},r={name:r.name||r.alt||"Feature Image",accepted:!0,kind:"image",upload:{filename:r.name||r.alt||"Feature Image",uuid:r.uuid||r.id},dataURL:r.url,id:r.id,media_edit_data:d,width:r.width,height:r.height,cropped:r.cropped||!1};if(i&&i.dropzone){var s=i.dropzone;s.files.push(r),s.emit("addedfile",r),c.createThumbnailFromUrl(r,s),s.emit("dz-success"),s.emit("dz-complete"),setTimeout(function(){var e=l(i).find(".dz-preview");e.length&&e.attr("data-position","center")},100)}else if(a.length&&void 0!==window.Dropzone)return c.initializeDropzone(a),n=e,o=t,void setTimeout(function(){var e=l("#activity-post-feature-image-uploader")[0];e&&e.dropzone&&c.injectFeatureImageFiles(n,o)},50);t.set("bb_activity_post_feature_image",d)}}},createThumbnailFromUrl:function(t,a){var e;a&&t&&((e=t.dataURL||t.url)&&"string"==typeof e&&"[object Event]"!==e?a.createThumbnailFromUrl(t,a.options.thumbnailWidth,a.options.thumbnailHeight,a.options.thumbnailMethod,!0,function(e){a.emit("thumbnail",t,e),a.emit("complete",t)}):console.warn(c.bbActivityFeatureImage.strings.invalid_thumbnail_url,e))},handleActivityDraftCollectActivity:function(e){var t=e.model.get("bb_activity_post_feature_image");"group"===e.model.get("object")&&!_.isUndefined(t)&&t?(t.group_id=e.model.get("item_id"),e.model.set("bb_activity_post_feature_image",t)):!_.isUndefined(t)&&t&&(delete t.group_id,e.model.set("bb_activity_post_feature_image",t))},hasFeatureImages:function(){var e=c.getCurrentModel();return!!e&&(e=e.get("bb_activity_post_feature_image"),!_.isUndefined(e))&&null!==e},initFeatureImageView:function(){"undefined"!=typeof bp&&bp.Views&&(bp.Views.activityPostFeatureImageForm=Backbone.View.extend({tagName:"div",id:"bb-activity-post-feature-image",className:"bb-activity-post-feature-image-container bb-activity-post-feature-image",template:bp.template("bb-activity-post-feature-image-form"),initialize:function(){this.model.on("change:activity_post_featured_image",this.render,this)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.hide(),this.positionContainer(),this},positionContainer:function(){var e="#whats-new-form",t=(l(e).length||(e="#bb-rl-whats-new-form"),"#user-status-huddle"),a=(l(t).length||(t="#bb-rl-user-status-huddle"),l(e+" "+t));(a=a.length?a:l(e+" "+t)).length&&0===this.$el.prev(t).length&&this.$el.insertAfter(a)}}))},isReadyToInitialize:function(){var e="#whats-new-form";return l(e).length||(e="#bb-rl-whats-new-form"),l(e).length&&"undefined"!=typeof bp&&bp.Nouveau&&bp.Nouveau.Activity},initializeFeatureImage:function(e,t){return!(t||!this.isReadyToInitialize()||(c.init(),e&&e.disconnect(),0))},setupMutationObserver:function(n){var e;return"undefined"==typeof MutationObserver?null:((e=new MutationObserver(function(e){e.forEach(function(e){if("childList"===e.type&&0<e.addedNodes.length)for(var t=0;t<e.addedNodes.length;t++){var a=e.addedNodes[t];if(a.nodeType===Node.ELEMENT_NODE){var i="whats-new-form",r="#"+i;if(l(r).length||(r="#bb-rl-"+(i="bb-rl-whats-new-form")),a.id===i||l(a).find(r).length)return void setTimeout(n,100)}}})})).observe(document.body,{childList:!0,subtree:!0}),e)}};l(function(){c.init()}),window.BBActivityPostFeatureImage=c}(jQuery);